\ProvidesExplPackage{theorem-keys}{}{0.0.0gamma}{l3 thmtools implementation}

\RequirePackage{amsthm}

\DeclareOption{overload}
  {
    \AddToHook{package/theorem-keys/after}
      {
        \RenewDocumentCommand{\newtheorem}{smomo}
          {
            \IfBooleanTF { #1 }
              { \thmkeys_thm_NewThm:nn { #2 } { numbered=no } }
              {
                \IfNoValueTF { #3 }
                  {
                    \IfNoValueTF { #5 }
                      { \thmkeys_thm_NewThm:nn { #2 } { } }
                      { \thmkeys_thm_NewThm:nn { #2 } { parent=#5 } }
                  }
                  { \thmkeys_thm_NewThm:nn { #2 } { sibling=#3 } }
              }
          }
      }
  }

\ProcessOptions

\clist_new:N \g__thmkeys_restatecounters_clist
\clist_set:Nn \g__thmkeys_restatecounters_clist { equation }

%%%%%%%%%%%%%%%%%%%
%%% Global Keys %%%
%%%%%%%%%%%%%%%%%%%

\keys_define:nn { thmkeys }
  {
    restate-counters .code:n =
      { \clist_put_right:Nn \g__thmkeys_restatecounters_clist { #1 } },
    continues-code .code:n =
      { \cs_set:Nn \thmkeys_thmuse_continues:n { #1 } },
  }

\NewDocumentCommand { \ThmKeysSet } { m } { \keys_set:nn { thmkeys } { #1 } }

%%%%%%%%%%%%%%
%%% Styles %%%
%%%%%%%%%%%%%%

% \__thmkeys_thmstyle_setbraces:nn { <left brace> } { <right brace> }
\cs_new_protected:Npn \thmkeys_thmstyle_setbraces:nn #1#2
  {
    \tl_set:Nn \l__thmkeys_thmstyle_leftbrace_tl {#1}
    \tl_set:Nn \l__thmkeys_thmstyle_rightbrace_tl {#2}
  }

\keys_define:nn { thmkeys/thmstyle }
  {
    spaceabove    .tl_set:N = \l__thmkeys_thmstyle_spaceabove_tl,
    spacebelow    .tl_set:N = \l__thmkeys_thmstyle_spacebelow_tl,
    bodyfont      .tl_set:N = \l__thmkeys_thmstyle_bodyfont_tl,
    headindent    .tl_set:N = \l__thmkeys_thmstyle_headindent_tl,
    headfont      .tl_set:N = \l__thmkeys_thmstyle_headfont_tl,
    headpunct     .tl_set:N = \l__thmkeys_thmstyle_headpunct_tl,
    postheadspace .tl_set:N = \l__thmkeys_thmstyle_postheadspace_tl,
    break         .meta:n   = { postheadspace = \newline },
    notefont      .tl_set:N = \l__thmkeys_thmstyle_notefont_tl,
    notebraces    .code:n   = \exp_after:wN \thmkeys_thmstyle_setbraces:nn #1,
    headstyle     .choice:,
    headstyle / margin .code =
      {
        \cs_set:Nn \thmkeys_thmstyle_headcmd:nnn
          { \exp_not:N \makebox[0pt][r]{\NUMBER\ }\NAME\NOTE }
      },
    headstyle / swapnumber .code =
      {
        \cs_set:Nn \thmkeys_thmstyle_headcmd:nnn { \NUMBER\ \NAME\NOTE }
      },
    headstyle / unknown .cs_set:Np = \thmkeys_thmstyle_headcmd:nnn #1#2#3,
    headformat    .meta:n = { headstyle = #1 },
    inherit-style .choice:,
    inherit-style / plain .meta:n = {},
    inherit-style / definition .meta:n = { bodyfont = \normalfont },
    inherit-style / remark .meta:n =
      {
        headfont = \itshape,
        bodyfont = \normalfont,
        spaceabove = 0.5\topsep,
        spacebelow = 0.5\topsep,
      },
  }

\cs_new_protected:Nn \thmkeys_thmstyle_thmname:n { \thmname{#1} }
\cs_new_protected:Nn \thmkeys_thmstyle_thmnumber:n { \thmnumber{#1} }
\cs_new_protected:Nn \thmkeys_thmstyle_thmnote:n { \thmnote{#1} }

%% these are necessary! e.g. headformat={\thmname{#1}\thmnumber{ #2}\thmnote{ (#3)}} thinks note is always there
\cs_set_eq:NN \ThmName \thmkeys_thmstyle_thmname:n
\cs_set_eq:NN \ThmNumber \thmkeys_thmstyle_thmnumber:n
\cs_set_eq:NN \ThmNote \thmkeys_thmstyle_thmnote:n

\NewExpandableDocumentCommand { \NAME } { }
  {
    \thmkeys_thmstyle_thmname:n { ##1 }
  }
\NewExpandableDocumentCommand { \NUMBER } { }
  {
    \thmkeys_thmstyle_thmnumber:n { \exp_not:N \textup { ##2 } }
  }
\NewExpandableDocumentCommand { \NOTE } { }
  {
    \thmkeys_thmstyle_thmnote:n
      { ~ \group_begin: % group so notefont doesn't affect headpunct
        \exp_not:V \l__thmkeys_thmstyle_notefont_tl
        \l__thmkeys_thmstyle_leftbrace_tl ##3 \l__thmkeys_thmstyle_rightbrace_tl
        \group_end:
      }
  }

\cs_set:Npn \thmkeys_thmstyle_headcmd_default:nnn #1#2#3
  {
    \thmkeys_thmstyle_thmname:n { #1 }
    \thmkeys_thmstyle_thmnumber:n
      { \tl_if_empty:nF{#1}{~} \exp_not:N \textup{#2} } % this \tl_if_empty has no effect...
    \thmkeys_thmstyle_thmnote:n
      { ~ \group_begin: % group so notefont doesn't affect headpunct
        \exp_not:V \l__thmkeys_thmstyle_notefont_tl
        \l__thmkeys_thmstyle_leftbrace_tl #3 \l__thmkeys_thmstyle_rightbrace_tl
        \group_end:
      }
  }

\tl_new:N \l__thmkeys_thmstyle_defaultkeys_tl
\keys_precompile:nnN { thmkeys/thmstyle }
  {
    spaceabove    = \topsep,
    spacebelow    = \topsep,
    bodyfont      = \itshape,
    headindent    = 0pt,
    headfont      = \bfseries,
    headpunct     = {.},
    postheadspace = 5pt plus 1pt minus 1pt,
    notefont      = \fontseries\mddefault\upshape,
    notebraces    = {(}{)},
    headstyle     = \thmkeys_thmstyle_headcmd_default:nnn{#1}{#2}{#3},
  }
  \l__thmkeys_thmstyle_defaultkeys_tl

\NewDocumentCommand { \NewThmStyle } { m m }
  {
    \tl_use:N \l__thmkeys_thmstyle_defaultkeys_tl
    \keys_set:nn { thmkeys/thmstyle } { #2 }
    \thmkeys_thmstyle_new:nVVVVVVVe { #1 }
      \l__thmkeys_thmstyle_spaceabove_tl
      \l__thmkeys_thmstyle_spacebelow_tl
      \l__thmkeys_thmstyle_bodyfont_tl
      \l__thmkeys_thmstyle_headindent_tl
      \l__thmkeys_thmstyle_headfont_tl
      \l__thmkeys_thmstyle_headpunct_tl
      \l__thmkeys_thmstyle_postheadspace_tl
      {\thmkeys_thmstyle_headcmd:nnn{##1}{##2}{##3}}
    % Define new inherit-style key
    \keys_define:nn { thmkeys/thmstyle } { inherit-style / #1 .meta:n = { #2 } } % broken with headformat?
  }

\cs_new_eq:NN \thmkeys_thmstyle_new:nnnnnnnnn \newtheoremstyle
\cs_generate_variant:Nn \thmkeys_thmstyle_new:nnnnnnnnn { nVVVVVVVe }

%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Defining Theorems %%%
%%%%%%%%%%%%%%%%%%%%%%%%%

\bool_new:N \l__thmkeys_thm_numbered_bool

% \thmkeys_thm_setrefnames:n { <envname> } { <refname> or <sing,plural> }
\NewDocumentCommand { \thmkeys_thm_setrefnames:nn } { m >{\SplitArgument{1}{,}} m }
  { \__thmkeys_thm_setrefnames_aux:nnn{#1}#2 } % not sure why brace around #1 needed
\cs_new_protected:Npn \__thmkeys_thm_setrefnames_aux:nnn #1#2#3
  {
    \cs_set:cpn { #1 autorefname } { #2 }
    \cs_if_exist:NT \crefname 
      { 
        \tl_if_novalue:nTF { #3 }
          { \crefname{#1}{#2}{\textbf{??~(pl.~#2)}} }
          { \crefname{#1}{#2}{#3} }
      }
  }

% \thmkeys_thm_setRefnames:n { <envname> } { <refname> or <sing,plural> }
\NewDocumentCommand { \thmkeys_thm_setRefnames:nn } { m >{\SplitArgument{1}{,}} m }
  { \__thmkeys_thm_setRefnames_aux:nnn{#1}#2 } % not sure why brace around #1 needed
\cs_new_protected:Npn \__thmkeys_thm_setRefnames_aux:nnn #1#2#3
  {
    \cs_set:cpn { #1 Autorefname } { #2 }
    \cs_if_exist:NT \Crefname 
      { 
        \tl_if_novalue:nTF { #3 }
          { \Crefname{#1}{#2}{\textbf{??~(pl.~#2)}} }
          { \Crefname{#1}{#2}{#3} }
      }
  }
  
\keys_define:nn { thmkeys/thm }
  {
    name           .tl_set:N  = \l__thmkeys_thm_name_tl,
    title          .meta:n    = { name = #1 },
    heading        .meta:n    = { name = #1 },
    numbered       .choice:,
    numbered / yes .code      = \bool_set_true:N \l__thmkeys_thm_numbered_bool,
    numbered / no  .code      = \bool_set_false:N \l__thmkeys_thm_numbered_bool,
    numbered       .default:n = yes,
    parent         .tl_set:N  = \l__thmkeys_thm_parent_tl,
    numberwithin   .meta:n    = { parent = #1 },
    within         .meta:n    = { parent = #1 },
    sibling        .tl_set:N  = \l__thmkeys_thm_sibling_tl,
    numberlike     .meta:n    = { sibling = #1 },
    sharenumber    .meta:n    = { sibling = #1 },
    style          .tl_set:N  = \l__thmkeys_thm_style_tl,
    preheadhook    .tl_set:N  = \l__thmkeys_thm_preheadhook_tl,
    postheadhook   .tl_set:N  = \l__thmkeys_thm_postheadhook_tl,
    prefoothook    .tl_set:N  = \l__thmkeys_thm_prefoothook_tl,
    postfoothook   .tl_set:N  = \l__thmkeys_thm_postfoothook_tl,
    refname        .tl_set:N  = \l__thmkeys_thm_refname_tl,
    Refname        .tl_set:N  = \l__thmkeys_thm_Refname_tl,
    qed            .code:n    = %% Copied from thmtools
      {
        \AddToTheoremPostHeadHook[\l__thmkeys_thm_envname_tl]{
          \protected@edef\qedsymbol{#1}
          \pushQED{\qed}
          }
        % Use label to make sure it's last. Might need to adjust to avoid conflict with other chunks added to prefoot hook
        \AddToHook{theorem-keys/\l__thmkeys_thm_envname_tl/prefoot}[qed]{
          \protected@edef\qedsymbol{#1}
          \popQED
          }
       },
    qed            .default:n = \openbox,
    tcolorbox      .code:n    =
      {
        \RequirePackage{tcolorbox}
        \AddToTheoremPreHeadHook[\l__thmkeys_thm_envname_tl]
          {
            \begin{tcolorbox}[
              savedelimiter={\l__thmkeys_thm_envname_tl},wrap@environment,#1
              ]
          }
        \AddToTheoremPostFootHook[\l__thmkeys_thm_envname_tl]
          {
            \end{tcolorbox}
          }
      },
    tcolorbox    .default:n = {},
  }

\tl_new:N \l__thmkeys_thm_defaultkeys_tl
\keys_precompile:nnN { thmkeys/thm }
  {
    name         = \q_no_value,
    numbered     = yes,
    parent       = {},
    sibling      = {},
    style        = {},
    preheadhook  = {},
    postheadhook = {},
    prefoothook  = {},
    postfoothook = {},
    refname      = \q_no_value,
    Refname      = \q_no_value,
  }
  \l__thmkeys_thm_defaultkeys_tl

\cs_new_protected:Npn \thmkeys_thm_makethmhooks:n #1
  {
    \NewHook{ theorem-keys/#1/prehead}
    \NewHook{ theorem-keys/#1/posthead }
    \NewReversedHook{ theorem-keys/#1/prefoot }
    \NewReversedHook{ theorem-keys/#1/postfoot }
  }

\prop_new:N \g__thmkeys_thmnames_prop % for retrieving name from envname
\seq_new:N \g__thmkeys_thmnames_envnames_seq % to compare for \ListOfThms
% ^ Want to avoid this extra data struc and just use above prop, but then a global
% \ThmKeysListSet{ignore=foo} would remove foo from prop which is used elsewhere

% Make generic theorem hooks
\thmkeys_thm_makethmhooks:n { allthms }

%% Inefficiences: don't need to store and reset style every time.
%% I do, however, need to set/reset keys each time so that envname is correct.
\NewDocumentCommand { \NewThm } { m O{} }
  {
    \clist_map_inline:nn { #1 } % define multiple theorems at once
      { \thmkeys_thm_NewThm:nn { ##1 } { #2 } }
  }

% \thmkeys_thm_NewThm:nn { <envname> } { <keys> }
\cs_new_protected:Npn \thmkeys_thm_NewThm:nn #1#2
  {
    % Store theorem style
    \tl_set:Ne \l__thmkeys_currentthmstyle_tl { \the\thm@style }
    % Store envname
    \tl_set:Nn \l__thmkeys_thm_envname_tl { #1 }
    % Set default keys
    \tl_use:N \l__thmkeys_thm_defaultkeys_tl
    % Set env-specific keys
    \keys_set:nn { thmkeys/thm } { #2 }
    % Temporarily set style if style key given
    \tl_if_empty:NF \l__thmkeys_thm_style_tl { \theoremstyle{ \l__thmkeys_thm_style_tl } }
    % Set up env-specific hooks
    \thmkeys_thm_makethmhooks:n { #1 }
    % Add to env-specific hooks (use label so code given in keys is outermost)
    \exp_args:NnnV \hook_gput_code:nnn 
      { theorem-keys/#1/prehead } { hook-keys } \l__thmkeys_thm_preheadhook_tl
    \exp_args:NnnV \hook_gput_code:nnn
      { theorem-keys/#1/posthead } { hook-keys } \l__thmkeys_thm_postheadhook_tl
    \exp_args:NnnV \hook_gput_code:nnn
      { theorem-keys/#1/prefoot } { hook-keys } \l__thmkeys_thm_prefoothook_tl
    \exp_args:NnnV \hook_gput_code:nnn
      { theorem-keys/#1/postfoot } { hook-keys } \l__thmkeys_thm_postfoothook_tl
    % Set name if none given
    \quark_if_no_value:NT \l__thmkeys_thm_name_tl % use quark so name={} is valid
      {
        \tl_set:Ne \l__thmkeys_thm_name_tl
          { \text_titlecase_first:n { \l__thmkeys_thm_envname_tl } }
      }
    % associate formatted name with envname in prop list
    \prop_gput:NnV \g__thmkeys_thmnames_prop { #1 } \l__thmkeys_thm_name_tl
    % add envname to listof clist (see note above)
    \seq_gput_right:Nn \g__thmkeys_thmnames_envnames_seq { #1 }
    % Call correct \newtheorem variant
    \bool_if:NTF \l__thmkeys_thm_numbered_bool
      {
        \tl_if_empty:NTF \l__thmkeys_thm_parent_tl
          {
            \tl_if_empty:NTF \l__thmkeys_thm_sibling_tl
              { \__thmkeys_thm_new:nV { #1 } \l__thmkeys_thm_name_tl }
              {
                %% NOTE: need this unconditionally for \PrintThms
                \RequirePackage{aliascnt}
                \exp_args:NVV \newaliascnt \l__thmkeys_thm_envname_tl \l__thmkeys_thm_sibling_tl
                \__thmkeys_thm_new_sibling:nVV { #1 } \l__thmkeys_thm_name_tl \l__thmkeys_thm_envname_tl
                \exp_args:NV \aliascntresetthe \l__thmkeys_thm_envname_tl
              }
          }
          {
            \__thmkeys_thm_new_parent:nVV { #1 } \l__thmkeys_thm_name_tl \l__thmkeys_thm_parent_tl
          }
      }
      {
        \__thmkeys_thm_new_nonumber:nV { #1 } \l__thmkeys_thm_name_tl
      }
    % Store theorem def so we can redefine it with keys
    \thmkeys_keyify_theorem:n { #1 }
    % define \<env>autorefname and \<env>Autorefname, might be redefined next
    \tl_set:cV { #1 autorefname } \l__thmkeys_thm_name_tl
    \tl_set:cV { #1 Autorefname } \l__thmkeys_thm_name_tl
    % Set ref names
    \quark_if_no_value:NF \l__thmkeys_thm_refname_tl
      {
        \exp_args:NnV \thmkeys_thm_setrefnames:nn { #1 } \l__thmkeys_thm_refname_tl
      }
    \quark_if_no_value:NF \l__thmkeys_thm_Refname_tl 
      {
        \exp_args:NnV \thmkeys_thm_setRefnames:nn { #1 } \l__thmkeys_thm_Refname_tl
      }
    % Set default list-of display command (only if undefined)
    \__thmkeys_listof_show_aux:n { #1 }
    % Set theorem style back to original state
    % Note: if thmtools also loaded, \exp_args:NV hangs, hence the :Ne
    \exp_args:Ne \theoremstyle { \l__thmkeys_currentthmstyle_tl }
  }

% \newtheorem variants
\cs_new_eq:NN \__thmkeys_thm_new:nn \newtheorem
\cs_generate_variant:Nn \__thmkeys_thm_new:nn { nV }

\cs_new_protected:Npn \__thmkeys_thm_new_nonumber:nn #1#2 { \__thmkeys_thm_new:nn*{#1}{#2} }
\cs_generate_variant:Nn \__thmkeys_thm_new_nonumber:nn { nV }

\cs_new_protected:Npn \__thmkeys_thm_new_parent:nnn #1#2#3 { \__thmkeys_thm_new:nn{#1}{#2}[#3] }
\cs_generate_variant:Nn \__thmkeys_thm_new_parent:nnn { nVV }

\cs_new_protected:Npn \__thmkeys_thm_new_sibling:nnn #1#2#3 { \__thmkeys_thm_new:nn{#1}[#3]{#2} }
\cs_generate_variant:Nn \__thmkeys_thm_new_sibling:nnn { nVV }

\keys_define:nn { thmkeys/thmuse }
  {
    label     .code:n   = \AddToHookNext{ cmd/deferred@thm@head/after }{ \label{ #1 } },
    % ^ maybe better to add to usual posthead hook and declare a rule
    name      .tl_set:N = \l__thmkeys_thmuse_name_tl,
    continues .tl_set:N = \l__thmkeys_thmuse_contlabel_tl,
    restate   .tl_set:N = \l__thmkeys_thmuse_restate_tl,
  }

%% Adapted from https://tex.stackexchange.com/a/481221/208544
% allocate the needed variables
\prop_new:N \g__thmkeys_thmuse_othercounters_prop
\seq_new:N \g__thmkeys_thmuse_seq
\tl_new:N \l__thmkeys_thmuse_number_tl

% \thmkeys_keyify_theorem:n { <envname> }
%% NOTE: should only grab body for restatable... but how? Actually might be ok efficiency-wise
\cs_new_protected:Npn \thmkeys_keyify_theorem:n #1
  {
    \NewEnvironmentCopy { orig_#1 } { #1 }
    \bool_if:NTF \l__thmkeys_thm_numbered_bool
      { % numbered
        \RenewDocumentEnvironment { #1 } { ={name} O{} +b }
          {
            \keys_set:nn { thmkeys/thmuse } { ##1 }
            \thmkeys_thmuse_prebody:n { #1 }
            \tl_gset:Ne \l__thmkeys_thmuse_number_tl { \use:c {@currentlabel} }
            \clist_map_inline:Nn \g__thmkeys_restatecounters_clist
              { \prop_gput:Nne \g__thmkeys_thmuse_othercounters_prop { ####1 } { \the\value{####1} } }
            ##2
            \thmkeys_thmuse_postbody:n { #1 }
            \seq_gput_right:Nx \g__thmkeys_thmuse_seq % Why is variant \seq_gput_right:Ne not defined by default?
              {
                { #1 } % envname
                { \l__thmkeys_thmuse_number_tl } % number
                { \exp_not:n { ##1 } } % keys
                { \exp_not:n { ##2 } } % body
                { \prop_to_keyval:N \g__thmkeys_thmuse_othercounters_prop }
              }
            \tl_if_empty:NF \l__thmkeys_thmuse_restate_tl
              {
                \seq_get_right:NN \g__thmkeys_thmuse_seq \l__thmkeys_thmuse_savethmargs_tl
                \exp_args:Nee \cs_new:cpn { \l__thmkeys_thmuse_restate_tl } % a better way?
                  {
                    \exp_not:N \ThmKeysSavedTheorem \exp_not:V \l__thmkeys_thmuse_savethmargs_tl
                  }
              }
          }
          {}
     }
     { % unnumbered
       \RenewDocumentEnvironment { #1 } { ={name} O{} +b }
         {
           \keys_set:nn { thmkeys/thmuse } { ##1 }
           \thmkeys_thmuse_prebody:n { #1 }
           \clist_map_inline:Nn \g__thmkeys_restatecounters_clist
             { \prop_gput:Nne \g__thmkeys_thmuse_othercounters_prop { ####1 } { \the\value{####1} } }
           ##2
           \thmkeys_thmuse_postbody:n { #1 }
           \seq_gput_right:Nx \g__thmkeys_thmuse_seq
             {
               *
               { #1 } % name
               { } % number
               { \exp_not:n { ##1 } } % keys
               { \exp_not:n { ##2 } } % body
               { \prop_to_keyval:N \g__thmkeys_thmuse_othercounters_prop }
             }
           \tl_if_empty:NF \l__thmkeys_thmuse_restate_tl
             {
               \seq_get_right:NN \g__thmkeys_thmuse_seq \l__thmkeys_thmuse_savethmargs_tl
               \exp_args:Nee \cs_gset:cpn { \l__thmkeys_thmuse_restate_tl } % a better way?
                 {
                   \exp_not:N \ThmKeysSavedTheorem \exp_not:V \l__thmkeys_thmuse_savethmargs_tl
                 }
             }
         }
         {}
     }
  }

\cs_new:Npn \__thmkeys_ref_starred #1 { \ref*{#1} }

\cs_new_protected:Npn \thmkeys_thmuse_prebody:n #1
  {
    \UseHook{ theorem-keys/#1/prehead }
    \UseHook{ theorem-keys/allthms/prehead }
    \tl_if_empty:NF \l__thmkeys_thmuse_contlabel_tl
      {
        \tl_if_empty:NF \l__thmkeys_thmuse_name_tl
          { \tl_put_right:Nn \l__thmkeys_thmuse_name_tl { , ~ } }
        \tl_put_right:Nn \l__thmkeys_thmuse_name_tl
          { \exp_args:NV \thmkeys_thmuse_continues:n \l__thmkeys_thmuse_contlabel_tl }
        \cs_set:cpn { the #1 }
          { \exp_args:Ne \__thmkeys_ref_starred { \l__thmkeys_thmuse_contlabel_tl } }
          % ^ apparently V expansion is not enough, error if label= is given too
        \cs_set_eq:cN { c@ #1 } \c@thmkeys_dummyctr
      }
    \tl_if_empty:NTF \l__thmkeys_thmuse_name_tl
      { \__thmkeys_orig_begin:n { #1 } }
      { \__thmkeys_orig_begin:nV { #1 } \l__thmkeys_thmuse_name_tl }
    \UseHook{ theorem-keys/#1/posthead }
    \UseHook{ theorem-keys/allthms/posthead }
    \ignorespaces % space added without this (or not? check)
  }

\cs_new_protected:Npn \thmkeys_thmuse_postbody:n #1
  {
    \UseHook{ theorem-keys/allthms/prefoot }
    \UseHook{ theorem-keys/#1/prefoot }
    \end{orig_#1}
    \UseHook{ theorem-keys/allthms/postfoot }
    \UseHook{ theorem-keys/#1/postfoot }
  }

\cs_new_protected:Nn \__thmkeys_orig_begin:n { \begin{orig_#1} }
\cs_new_protected:Nn \__thmkeys_orig_begin:nn { \begin{orig_#1}[#2] }
\cs_generate_variant:Nn \__thmkeys_orig_begin:nn { nV }

% \thmkeys_thmuse_continues:n { <label> }
\cs_new:Nn \thmkeys_thmuse_continues:n
  {
    \cs_if_exist:NTF \hyperref
      { \hyperref[#1]{continuing} ~ }
      { continuing ~ }
    from~p.\,\pageref{#1}
  }

%%%%%%%%%%%%%%%%%%%%%
%%% Theorem Hooks %%%
%%%%%%%%%%%%%%%%%%%%%

%%% \AddToTheorem<hook>Hook[<envname>]{<code>}
\NewDocumentCommand { \AddToTheoremPreHeadHook } { o m }
  {
    \IfNoValueTF { #1 }
      { \AddToHook{ theorem-keys/allthms/prehead }{ #2 } }
      { \AddToHook{ theorem-keys/#1/prehead }{ #2 } }
  }
\NewDocumentCommand { \AddToTheoremPostHeadHook } { o m }
  {
    \IfNoValueTF { #1 }
      { \AddToHook{ theorem-keys/allthms/posthead }{ #2 } }
      { \AddToHook{ theorem-keys/#1/posthead }{ #2 } }
  }
\NewDocumentCommand { \AddToTheoremPreFootHook } { o m }
  {
    \IfNoValueTF { #1 }
      { \AddToHook{ theorem-keys/allthms/prefoot }{ #2 } }
      { \AddToHook{ theorem-keys/#1/prefoot }{ #2 } }
  }
\NewDocumentCommand { \AddToTheoremPostFootHook } { o m }
  {
    \IfNoValueTF { #1 }
      { \AddToHook{ theorem-keys/allthms/postfoot }{ #2 } }
      { \AddToHook{ theorem-keys/#1/postfoot }{ #2 } }
  }
  
%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Restating Theorems %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%

% print the stored theorems
% NOTE: If you want to print theorems before they're called in the document,
%       we need to write to file. See code in 0.0.0alpha.
\NewDocumentCommand { \PrintThms } { }
  {
    \seq_map_inline:Nn \g__thmkeys_thmuse_seq { \ThmKeysSavedTheorem ##1 }
  }

% stealing from thm-restate
\newcounter{thmkeys_dummyctr}
\cs_gset:Npn \theHthmkeys_dummyctr { dummy.\arabic{thmkeys_dummyctr} }
\cs_gset:Npn \thethmkeys_dummyctr { }

\NewDocumentCommand { \ThmKeysSavedTheorem } { smmmmm }
  {
    \prop_set_from_keyval:Nn \g__thmkeys_thmuse_othercounters_prop { #6 }
    \group_begin:
    \prop_map_inline:Nn \g__thmkeys_thmuse_othercounters_prop
      {
        \tl_gset:ce { l_thmkeys_restate_current_##1_tl } { \the\value{##1} }
        \setcounter { ##1 } { ##2 } % FIX: what if eq's numbered by section, theorem, etc.?
        \cs_set_eq:cN { theH ##1 } \theHthmkeys_dummyctr
      }
    \IfBooleanF{#1}
      {
        \cs_set:cpn { the #2 } { #3 }
        \cs_set_eq:cN { c@ #2 } \c@thmkeys_dummyctr
        \cs_set_eq:cN { theH #2 } \theHthmkeys_dummyctr
      }
    \cs_set_eq:NN \label \use_none:n % disable \label
    \keys_set:nn { thmkeys/thmuse } { #4 }
    \thmkeys_thmuse_prebody:n { #2 }
    #5
    \thmkeys_thmuse_postbody:n { #2 }
    \group_end:
    \prop_map_inline:Nn \g__thmkeys_thmuse_othercounters_prop
      {
        \exp_args:Nnc \setcounter { ##1 } { l_thmkeys_restate_current_##1_tl }
      }
  }

%%%%%%%%%%%%%%%%%%%%%%%%
%%% List of Theorems %%%
%%%%%%%%%%%%%%%%%%%%%%%%

\keys_define:nn { thmkeys/listofthms }
  {
    numwidth   .dim_set:N = \l__thmkeys_listof_numwidth_dim,
    ignore     .code:n    =
      {
        \AddToHook{ begindocument/before } { \thmkeys_listof_ignore:n { #1 } }
      },
    onlynamed  .code:n    = ,
    show       .code:n    =
      {
        \AddToHook{ begindocument/before } { \thmkeys_listof_show:n { #1 } }
      },
    ignoreall  .code:n    =
      {
        \AddToHook{ begindocument/before } % in case called before theorem defined
          {
            \seq_map_inline:Nn \g__thmkeys_thmnames_envnames_seq
              { \__thmkeys_listof_ignore_aux:n { ##1 } }
          }
      },
    showall    .code:n    =
      {
        \AddToHook{ begindocument/before } % in case called before theorem defined
          {
            \seq_map_inline:Nn \g__thmkeys_thmnames_envnames_seq
              { \__thmkeys_listof_show_aux:n { ##1 } }
          }
      },
    title      .tl_set:N   = \l__thmkeys_listof_title_tl,
    swapnumber .bool_set:N = \l__thmkeys_listof_swapnumber_bool,
  }

\AddToHook{ begindocument } % redefine these keys after begindocument
  {
    \keys_define:nn { thmkeys/listofthms }
      {
        ignore    .code:n = \thmkeys_listof_ignore:n { #1 },
        show      .code:n = \thmkeys_listof_show:n { #1 },
        ignoreall .code:n =
          {
            \seq_map_inline:Nn \g__thmkeys_thmnames_envnames_seq
              { \__thmkeys_listof_ignore_aux:n { ##1 } }
          },
        showall   .code:n =
          {
            \seq_map_inline:Nn \g__thmkeys_thmnames_envnames_seq
              { \__thmkeys_listof_show_aux:n { ##1 } }
          },
      }
  }

\NewDocumentCommand { \ThmKeysListSet } { m } % find better name...
  { \keys_set:nn { thmkeys/listofthms } { #1 } }

\cs_new_protected:Npn \thmkeys_listof_ignore:n #1 
  {
    \clist_map_inline:nn { #1 } { \__thmkeys_listof_ignore_aux:n { ##1 } }
  }
\cs_new_protected:Npn \__thmkeys_listof_ignore_aux:n #1 
  {
    \exp_args:Nc \DeclareDocumentCommand { __thmkeys_thmitem_#1: } { smmmmm } { }
  }

\cs_new_protected:Npn \thmkeys_listof_show:n #1 
  {
    \clist_map_inline:nn { #1 } { \__thmkeys_listof_show_aux:n { ##1 } }
  }
\cs_new_protected:Npn \__thmkeys_listof_show_aux:n #1 
  {
    \exp_args:Nc \DeclareDocumentCommand { __thmkeys_thmitem_#1: } { smmmmm }
      {
        ##3 ~ \prop_item:Nn \g__thmkeys_thmnames_prop {##2} ~
        \__thmkeys_listof_printheading:n { ##4 } ~ \dots \par
      }
  }

% Seems unnecessary to repeat all this for reading the keyvals from seq
\keys_define:nn { thmkeys/listofheading }
  {
    name .tl_set:N = \l__thmkeys_listof_name_tl,
    label .code:n = , % do nothing
    continues .tl_set:N = \l__thmkeys_listof_contlabel_tl,
    restate .code:n = , % do nothing
  }

\NewExpandableDocumentCommand { \thmkeys_envname_fromsequence: } { smmmmm } { #2 }

\cs_new:Npn \__thmkeys_listof_printheading:n #1
  {
    \group_begin:
    \keys_set:nn { thmkeys/listofheading } { #1 }
    \tl_if_empty:NF \l__thmkeys_listof_contlabel_tl
      {
        \tl_if_empty:NF \l__thmkeys_listof_name_tl
          { \tl_put_right:Nn \l__thmkeys_listof_name_tl { , ~ } }
        \tl_put_right:Nn \l__thmkeys_listof_name_tl
          { \exp_args:NV \thmkeys_thmuse_continues:n \l__thmkeys_listof_contlabel_tl }
      }
    \tl_if_empty:NF \l__thmkeys_listof_name_tl { ( \l__thmkeys_listof_name_tl ) }
    \group_end:
  }

\NewDocumentCommand { \ListOfThms } { O{} }
  {
    \group_begin:
    \keys_set:nn { thmkeys/listofthms } { #1 }
    \seq_map_inline:Nn \g__thmkeys_thmuse_seq
      {
        \tl_set:Ne \l_tmpa_tl { \exp_after:wN \thmkeys_envname_fromsequence: ##1 }
        \use:c { __thmkeys_thmitem_ \l_tmpa_tl : } ##1
      }
    \group_end:
  }

%%%%%% The approach below doesn't work! %%%%%%%%%%%%%%%
%% logic below with "ignore" and "show" is wrong. For example with
%%    \ThmKeysListSet{show=foo}
%%    \ListOfThms[ignore=foo]
%% you expect the last call to win, i.e. foo ignored, but this fails here

%\clist_new:N \l__thmkeys_listof_ignore_clist
%\clist_new:N \l__thmkeys_listof_onlynamed_clist
%\clist_new:N \l__thmkeys_listof_show_clist
%
%\keys_define:nn { thmkeys/listofthms }
%  {
%    numwidth   .dim_set:N   = \l__thmkeys_listof_numwidth_dim,
%    ignore     .code:n = \clist_put_right:Nn \l__thmkeys_listof_ignore_clist { #1 }, % cumulative
%    onlynamed  .code:n = \clist_put_right:Nn \l__thmkeys_listof_onlynamed_clist { #1 },
%    show       .code:n = \clist_put_right:Nn \l__thmkeys_listof_show_clist { #1 },
%    ignoreall  .bool_set:N  = \l__thmkeys_listof_ignoreall_bool,
%    showall    .bool_set_inverse:N  = \l__thmkeys_listof_ignoreall_bool,
%    title      .tl_set:N    = \l__thmkeys_listof_title_tl,
%    swapnumber .bool_set:N  = \l__thmkeys_listof_swapnumber_bool,
%  }
%
%\cs_new:Npn \__thmkeys_listof_ignore:N #1
%  {
%    \clist_map_inline:Nn #1
%      { \clist_remove_all:Nn \l__thmkeys_listof_envnames_clist { ##1 } }
%  }
%
%\NewDocumentCommand { \ThmKeysListSet } { m } % find better name...
%  { \keys_set:nn { thmkeys/listofthms } { #1 } }
%
%%% Look at acro.sty for inspiration. Template idea is nice.
%%% Experimenting:
%
%\keys_define:nn { thmkeys/listofheading }
%  {
%    name .tl_set:N = \l__thmkeys_listofheading_tl,
%    label .code:n = , % do nothing
%    continues .code:n = , % do nothing
%    restate .code:n = , % do nothing
%  }
%
%\cs_new:Npn \__thmkeys_listof_printheading:n #1
%  {
%    \group_begin:
%    \keys_set:nn { thmkeys/listofheading } { #1 }
%    \tl_if_empty:NF \l__thmkeys_listofheading_tl { ( \l__thmkeys_listofheading_tl ) }
%    \group_end:
%  }
%
%\NewDocumentCommand { \thmkeys_thmitem: } { smmmmm }
%  {
%    #3 ~ \prop_item:Nn \g__thmkeys_thmnames_prop {#2} ~ \__thmkeys_listof_printheading:n { #4 } ~ \dots \par
%  }
%
%% NOTE: need \New... instead of expl3 for "star" argument. Should really just reformat
%% the data in \g__thmkeys_thmuse_seq
%\NewExpandableDocumentCommand { \thmkeys_envname_fromsequence: } { smmmmm } { #2 }
%
%\cs_generate_variant:Nn \clist_if_in:NnT {Ne}
%
%\NewDocumentCommand { \ListOfThms } { O{} }
%  {
%    \group_begin:
%    \keys_set:nn { thmkeys/listofthms } { #1 }
%    \bool_if:NTF \l__thmkeys_listof_ignoreall_bool
%      { \clist_clear_new:N \l__thmkeys_listof_envnames_clist }
%      { \clist_set_from_seq:NN \l__thmkeys_listof_envnames_clist \g__thmkeys_thmnames_envnames_seq }
%    \clist_if_empty:NF \l__thmkeys_listof_ignore_clist
%      { \__thmkeys_listof_ignore:N \l__thmkeys_listof_ignore_clist }
%    \clist_if_empty:NF \l__thmkeys_listof_show_clist
%      { \clist_put_right:No \l__thmkeys_listof_envnames_clist { \l__thmkeys_listof_show_clist } }
%    \seq_map_inline:Nn \g__thmkeys_thmuse_seq
%      {
%        \clist_if_in:NeT \l__thmkeys_listof_envnames_clist
%          { \exp_after:wN \thmkeys_envname_fromsequence: ##1 } { \thmkeys_thmitem: ##1 }
%      }
%    \group_end:
%  }



%%% Questions
% 1. Are kernel hooks really better than simple token lists?
%    In particular, with token lists you have \tl_put_left to avoid all the hook
%    order issues
% 2. Should we allow \NewThm keys in \NewThmStyle like thmtools?

%%% Keys not yet implemented
% qed (in style; and all thm keys in style)
% numbered=unless unique

%%% Commands/envs not implemented
% \listoftheorems
% \begin{restatable} (no need?)
% \Autoref

%%% Notes
% Need to fix conditionals for spaces in \NAME, etc. Currently they always
%    evaluate to "not empty". Actually need to fix a lot. Try \textit{\NAME}